\documentclass[a4paper,kul]{kulakarticle} %options: kul or kulak (default)

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{subcaption}
\newlength{\twosubht}
\newsavebox{\twosubbox}
\graphicspath{{../Figures/}{../Matlab/}{/}}
\usepackage[outdir=./]{epstopdf}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{gensymb}
\setcounter{MaxMatrixCols}{21}

\usepackage{etoolbox,refcount}
\usepackage{multicol}

\newcounter{countitems}
\newcounter{nextitemizecount}
\newcommand{\setupcountitems}{%
	\stepcounter{nextitemizecount}%
	\setcounter{countitems}{0}%
	\preto\item{\stepcounter{countitems}}%
}
\makeatletter
\newcommand{\computecountitems}{%
	\edef\@currentlabel{\number\c@countitems}%
	\label{countitems@\number\numexpr\value{nextitemizecount}-1\relax}%
}
\newcommand{\nextitemizecount}{%
	\getrefnumber{countitems@\number\c@nextitemizecount}%
}
\newcommand{\previtemizecount}{%
	\getrefnumber{countitems@\number\numexpr\value{nextitemizecount}-1\relax}%
}
\makeatother    
\newenvironment{AutoMultiColItemize}{%
	\ifnumcomp{\nextitemizecount}{>}{3}{\begin{multicols}{2}}{}%
		\setupcountitems\begin{itemize}}%
		{\end{itemize}%
		\unskip\computecountitems\ifnumcomp{\previtemizecount}{>}{3}{\end{multicols}}{}}

\usepackage{pdflscape}

\date{Academic year 2021 -- 2022}
\address{
  Faculty of Engineering Science \\
  Department of Mechanical Engineering \\
  Control theory \texttt{[H04X3a]}}
\title{Report Assignment 1: Identification of the Motors}
\author{Toon Servaes, Matthias Derez}


\begin{document}

\maketitle

\section{Model Structure}
\subsection{Discrete-time Model Structure} 
\label{subsec:complex_model}
In order to select the discrete-time model structure for the DC motors, the equivalent electric circuit in Figure \ref{fig:DCmotors} is used. By using Newton's second law and Kirchhoff's voltage law, following equations can be derived:

\begin{equation}
    \label{eq:circuit}
    \begin{split}
         J\ddot{\theta}  + b\dot{\theta} &= K_{t}i \\
         L\frac{di}{dt} + Ri &= V - K_{e}\dot{\theta}
     \end{split} 
\end{equation}
The meaning of each parameter is:
\begin{itemize}
    \item $J$ = moment of inertia of the rotor [kg $\cdot$ m$^2$]
    \item $\theta$ = angular position [rad]
    \item $\omega = \dot{\theta}$ = angular velocity [rad/s]
    \item $b$ = motor viscous friction constant [N $\cdot$ m $\cdot$ s]
    \item $K_{e}$ = electromotive force constant [$\frac{\text{V}}{\text{rad } \cdot \text{ s}}$] = $K_{t}$ = motor torque constant [$\frac{\text{N } \cdot \text{ m}}{\text{A }}$] = $K$
    \item $R$ = electric resistance [$\ohm$]
    \item $L$ = electric inductance [H]
\end{itemize}

\subsubsection*{Continuous-time Transfer Function}
Applying the Laplace transform to both equations in (\ref{eq:circuit}) leads to:

\begin{equation}
\begin{split}
	&Js^2\Theta(s) + bs\Theta(s) = KI(s) \\
	&LsI(s) + RI(s) = V(s) - Ks\Theta(s)	
\end{split}
\end{equation}
assuming $\theta(0) = 0$, $\dot{\theta}(0) = 0 \text{ and } i(0) = 0$. After some calculations, the continuous-time transfer function describing the behaviour of this system can be derived:
\begin{equation}
	\label{eq:TF}
    H(s) = \frac{\Omega(s)}{V(s)} = \frac{\dot{\Theta}(s)}{V(s)} = \frac{s\Theta(s)}{V(s)} = \frac{K}{(Js + b)(Ls + R) + K^2}
\end{equation}
where the input is the voltage source $V(s)$ applied to the motor's armature and the output is the rotational velocity of the wheel  $\dot{\Theta}(s)$. One can rewrite this transfer function in order to obtain a more general and well-known form:
\begin{equation}
\label{eq:TF2}
\begin{split}
	H(s) &= \frac{K}{(Js + b)(Ls + R) + K^2} \\
	 &= \frac{K}{LJs^2 + (Lb + JR)s + K^2 + bR} \\
	 &= \frac{\frac{K}{LJ}}{s^2 + \frac{Lb + JR}{LJ}s + \frac{K^2 + bR}{LJ}} \\
	 &= C \frac{\omega_n^2}{s^2 + 2\zeta\omega_ns + \omega_n^2}
\end{split}
\end{equation}
where $C = \frac{K}{K^2 + bR}$, $\omega_n^2 = \frac{K^2 + bR}{LJ}$ and $\zeta = \frac{Lb+JR}{2\sqrt{LJ(K^2 + bR)}}$.


\begin{figure}[htp!]
    \centering
    \includegraphics[width=.6\linewidth]{DC_motors.png}
    \caption{Electric equivalent circuit of the armature and the free-body diagram of the rotor.}
    \label{fig:DCmotors}
\end{figure}


\subsubsection*{Discrete-time Transfer Function}

The discrete-time transfer function is derived from the continuous-time one by using a zero-order hold sampling process. To this extent, one has to compute $H(z) = (1-z^{-1}) \mathcal{Z} (\mathcal{L}^{-1}\{\frac{H(s)}{s}\} \times \delta_T(t))$. The software running on the Arduino, called 'MicroOS', samples at $100$ Hz. Consequently, the sampling period $T_s = 0.01$ s. 
\\\\
Firstly, Equation (\ref{eq:TF2}) can be rewritten as follows: 
\begin{equation}
	H(s) = C \frac{\omega_n^2}{s^2 + 2\zeta\omega_ns + \omega_n^2} = C \frac{a^2 + b^2}{(s+a)^2 + b^2}
\end{equation}
where $a = \zeta\omega_n$ and $b = \sqrt{\omega_n^2(1-\zeta^2)}$. Next, using transform pair no. 22 on page 4 of the course formulary leads to:
\begin{equation}
	\mathcal{Z} \left(\mathcal{L}^{-1}\left\{\frac{H(s)}{s}\right\} \times \delta_T(t)\right) = C \frac{z(Az+B)}{(z-1)\left[z^2-2e^{-aT_s}\cos(bT_s)z+e^{-2aT_s}\right]}
\end{equation}
where $A = 1-e^{-aT_s}\cos(bT_s) - \frac{a}{b}e^{-aT_s}\sin(bT_s)$ and $B = e^{-2aT_s}\cos(bT_s) + \frac{a}{b}e^{-aT_s}\sin(bT_s) - e^{-aT_s}\cos(bT_s)$. Finally, the zero-order hold equivalent is determined:
\begin{equation}
	H(z) = (1-z^{-1})\mathcal{Z} \left(\mathcal{L}^{-1}\left\{\frac{H(s)}{s}\right\} \times \delta_T(t)\right) = C \frac{(Az+B)}{\left[z^2-2e^{-aT_s}\cos(bT_s)z+e^{-2aT_s}\right]}
\end{equation}
More generally: 
\begin{equation}
	H(z) = \frac{b_0z + b_1}{z^2 + a_0 z + a_1}
\end{equation}
However, the MicroOS software on the Arduino stores the control command calculated during discrete-time interval $k$ in a memory buffer until discrete-time instance $k+1$. In this way, the delay between the measurement of the output and sending out of the control command is increased by one sampling period $T_s$. In the $z$-domain, this is equivalent to a multiplication of the transfer function by $z^{-1}$, leading to the final, generalised discrete-time transfer function of the system:
\begin{equation}
	\label{eq:TF3}
	H(z) = \frac{b_0z + b_1}{z^3 + a_0 z^2 + a_1 z}
\end{equation}
The ZOH discretization leads to an input delay of approximately $\frac{T_s}{2}$. Together with the delay introduced by the MicroOS software, the effective delay amounts to $\frac{3T_s}{2}$. Because the input and output data are observed at discrete time instances, a change in the input voltage is observed in the output $\lceil \frac{3}{2} \rceil T_s = 2T_s$ seconds, or equivalently, 2 time instances (samples) later. This is verified by Figure \ref{fig:delay}, where the input voltage sent to motor A changes at $t = 0.01$s, while the velocity changes at $t = 0.03$s. \\
\noindent In the final transfer function (\ref{eq:TF3}), the order of the numerator is 1, while the order of the denominator is 3. This is in line with the strict causality condition, which demands that the order of the numerator is strictly smaller than the denominator. 

\begin{figure}
	\centering
	\includegraphics[width=.5\linewidth]{delay.png}
	\caption{Snippet of the recorded data showing the delay between the input voltage and the motor velocity change.}
	\label{fig:delay}
\end{figure}


% ---------------------------------------------------------------------------
\subsection{Simplified Model}
Another, simplified model is also examined. The reason for this is that equally accurate results may be achieved using simpler equations. This simplified model is achieved by neglecting the inductance term in Equation \ref{eq:TF}, because its effect is several times smaller in comparison with the mechanical terms. This leads to:
\begin{equation}
\label{eq:TF_simple}
	\begin{split}
	H_{\text{simple}}(s) &= \frac{K}{JRs + (bR + K^2)} \\
	&= \frac{\frac{K}{JR}}{s + \frac{bR + K^2}{JR}} \\
	&= \frac{1}{C}\frac{a}{s + a}
	\end{split}
\end{equation}
where $C = \frac{K}{K^2 + bR}$, which is the same as in Equation \ref{eq:TF2}. Now, transform pair no. 12 leads to the zero-order hold equivalent of this simplified model:
\begin{equation}
	H_{\text{simple}}(z) = \frac{1}{C}\frac{1-e^{-aT_s}}{z-e^{-aT_s}}
\end{equation}
More generally:
\begin{equation}
	H_{\text{simple}}(z) = \frac{b_0}{z + a_0}
\end{equation}
Again, the delay is taken into account, resulting in the final, simplified, discrete-time transfer function of the system:
\begin{equation}
\label{eq:TF_simple2}
	H_{\text{simple}}(z) = \frac{b_0}{z^2 + a_0 z}
\end{equation}

\noindent Now, the order of the numerator is 0 and of the denominator 2. This means that the strict causality condition is again satisfied, while there is also a delay of 2 samples between input and output.
\\\\
Both the transfer functions of the complex model (\ref{eq:TF3}) and the simple model (\ref{eq:TF_simple2}) are used in the rest of the assignment. The unknown parameters $b_0$, $b_1$, $a_0$ and $a_1$ are determined in Section \ref{subsec:lse} using the least-squares method. This is done for each motor separately. Then, depending on which model gives the best results, either the complex or the simple model is chosen.
\\\\
From now on, the original model of Subsection \ref{subsec:complex_model} is referred to as the \textit{complex model} and this simplified model as \textit{simple model}.





% ---------------------------------------------------------------------------

\subsection{Input and Output}
As previously mentioned, the input of the model is the voltage source $V(s)$ applied to the motor's armature. This voltage is controlled by the Arduino and is expressed in Volts [V]. The output is the rotational velocity of the wheel  $\Omega(s) = \dot{\Theta}(s)$, expressed in [rad/s].

% ---------------------------------------------------------------------------

\section{Identification of each 'DC Motor + Wheel'}
\subsection{Excitation Signal}
In order to identify the system 'DC motor + wheel', it is necessary to perform a dedicated experiment that actively excites the system, while the \textit{persistency of excitation} condition is satisfied. This means that the excitation must be rich enough, i.e. so that all frequency modes of the system are excited and observable in the output. To this extent, a square wave is chosen, as displayed in Figure \ref{fig:IO} on the left. Note that the input voltage also remains $0$ for some time, instead of jumping to $-6$ or $6$ instantaneously. 
\\\\
This step-up step-down pattern is repeated four times in order to assess the noise. In Figure \ref{fig:omega_deltaomega}, the top plots show the motor velocities averaged out to one period of the square wave excitation. The bottom plots show the deviation of the motor velocities with regard to the averaged out velocities, for each of the periods (each with a different colour). The left plots are for motor A and the right ones for motor B. One can see that the motor velocities fluctuate not more than $\pm 3.5\%$, which is acceptable to work with for the rest of the assignment. There is no noise on the input voltage, as it is controlled by the user.

\begin{figure*}[htp!]
	\centering
	\begin{subfigure}[b]{0.485\textwidth}
		\centering
		\includegraphics[width=\textwidth]{input_voltage.eps}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.5\textwidth}  
		\centering 
		\includegraphics[width=\textwidth]{motor_velocity.eps}
	\end{subfigure}
	\caption{\textbf{Left}: Input voltage [V]. \textbf{Right}: Motor velocities [rad/s], for motor A and B respectively.} 
	\label{fig:IO}
\end{figure*}

\begin{figure*}[htp!]
	\centering
	\begin{subfigure}[b]{0.49\textwidth}
		\centering
		\includegraphics[width=\textwidth]{omegaA_deltaomegaA.eps}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.49\textwidth}  
		\centering 
		\includegraphics[width=\textwidth]{omegaB_deltaomegaB.eps}
	\end{subfigure}
	\caption{\textbf{Top}: Motor velocities averaged out to one period of the square wave excitation. \textbf{Bottom}: Deviation of the motor velocities with regard to the averaged out velocities, for each of the periods.} 
	\label{fig:omega_deltaomega}
\end{figure*}

% ---------------------------------------------------------------------------

\subsection{System Parameters}
\label{subsec:lse}
\subsubsection{Estimation criterion}

Now, the unknown parameters $b_0$, $b_1$, $a_0$ and $a_1$ of Equations \ref{eq:TF3} and \ref{eq:TF_simple2} are determined for each motor. This is done using the least squares method where the \textit{least squares criterion} is minimized: 
\begin{equation}
	\label{eq:lse}
	\text{min } V_N (\vec{\theta}, \vec{Z}^N) = \text{min }\sum_{t = 1}^{N}\frac{1}{2} \left[\omega[t] - \vec{\phi}^{\text{ }T}[t]\vec{\theta}\right]^2
\end{equation}
where $\vec{\theta}$ is \textbf{not} the angular position of the wheels, but a vector composed of the unknown coefficients, $\vec{Z}^N$ is the measured input and output data and $\vec{\phi}[t]$ is a vector containing the coefficients of the difference equation. Equation \ref{eq:lse} boils down to minimizing the squared error between the empirical output and the estimated output. 


\subsubsection*{Complex Model}
The difference equation of the complex model is derived as follows:
\begin{equation}
\begin{split}
\frac{\Omega(z)}{V(z)} &= \frac{b_0z + b_1}{z^3 + a_0 z^2 + a_1 z} \\
\iff (1 + a_0 z^{-1} + a_1 z^{-2})\Omega(z) &= (b_0 z^{-2} + b_1 z^{-3})V(z) \\
\iff \omega[t] + a_0 \omega[t-1] + a_1 \omega[t-2] &= b_0 V[t-2] + b_1 V[t-3] 
\end{split}
\end{equation}
This means that:
\begin{equation}
\begin{split}
\vec{\theta} &= \left[a_0\text{ }a_1\text{ }b_0\text{ }b_1\right]^T \\
\vec{\phi}[t] &= \left[-\omega[t-1]\text{ }-\omega[t-2]\text{ }V[t-2]\text{ }V[t-3]\right]^T
\end{split}
\end{equation}


\subsubsection*{Simple Model}
Analogously for the simple model:
\begin{equation}
\begin{split}
\frac{\Omega(z)}{V(z)} &= \frac{b_0}{z^2 + a_0 z} \\
\iff (1 + a_0 z^{-1})\Omega(z) &= b_0 z^{-2} V(z) \\	
\iff \omega[t] + a_0 \omega[t-1] &= b_0 V[t-2]
\end{split}
\end{equation}
This yields: 
\begin{equation}
\begin{split}
\vec{\theta}_{\text{simple}} &= \left[a_0\text{ }b_0\right]^T \\
\vec{\phi}[t]_{\text{simple}} &= \left[-\omega[t-1]\text{ }V[t-2]\right]^T
\end{split}
\end{equation}

\subsubsection{Results}
\noindent The unknown coefficients are determined using \texttt{Matlab}. This allows to construct the transfer function for each of the motors, as well as the locations of the poles and the zeros. These values are summarized in Table \ref{tab:overview} and visualized in Figure \ref{fig:pz}.
\\\\
As expected, the simple model has no zeros, because the numerator of the transfer function is of order 0. The NaN values in the table refer to the poles that are at the origin of the pole-zero map. Both models have such a pole, because of the multiplication by $z^{-1}$ to take the MicroOS delay into account. Further, for the simple model, the transfer functions for motor A and B are approximately the same, which explains why the poles coincide in Figure \ref{fig:pz_simple}.

\begin{table}[htp]
	\centering
	\caption{Overview of the complex and simple models for each motor.}
	\label{tab:overview}
	\bgroup
	\def\arraystretch{1.8}
	\begin{tabular}{|c||cc||cc|}
		\hline & \multicolumn{2}{c||}{\textbf{Complex}} & \multicolumn{2}{c|}{\textbf{Simple}} 
		\\ \hline \hline
		& \multicolumn{1}{c|}{Motor A} & Motor B & \multicolumn{1}{c|}{Motor A} & Motor B
		\\ \hline
		Transfer function & \multicolumn{1}{c|}{\scalebox{1.15}{$\frac{0.6952\text{ }z + 0.7978}{z^3 - 0.04632\text{ }z^2 - 0.242\text{ }z}$}} & \scalebox{1.15}{$\frac{0.6901\text{ }z + 0.6834}{z^3 - 0.2128\text{ }z^2 - 0.1303\text{ }z}$} & \multicolumn{1}{c|}{\scalebox{1.15}{$\frac{ 0.8842}{z^2 - 0.5787\text{ }z}$}} & \scalebox{1.15}{$\frac{0.8832}{z^2 - 0.5778\text{ }z}$} 
		\\ \hline
		Poles [rad/s] & \multicolumn{1}{c|}{66.2; 323; NaN} & 72.8; 340; NaN & \multicolumn{1}{c|}{54.7; NaN} & 54.9; NaN
		\\ \hline
		Zeros [rad/s] & \multicolumn{1}{c|}{314} & 314 & \multicolumn{1}{c|}{/} & /
		\\ \hline
	\end{tabular}
	\egroup
\end{table}


\begin{figure*}[htp!]
	\centering
	\begin{subfigure}[b]{0.48\textwidth}
		\centering
		\includegraphics[width=\textwidth]{p&z_complex_cropped.pdf}
		\caption{\textbf{Complex} model}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.48\textwidth}  
		\centering 
		\includegraphics[width=\textwidth]{p&z_simple_cropped.pdf}
		\caption{\textbf{Simple} model}
		\label{fig:pz_simple}
	\end{subfigure}
	\caption{Visualization of the poles and the zeros of both models, for each motor.} 
	\label{fig:pz}
\end{figure*}



% ---------------------------------------------------------------------------

\subsection{Filtering}
In the least-squares ARX model parameter estimation, the quadratic prediction error emphasises errors at high frequencies. Because noisy data typically resides at these high frequencies, low-pass data filtering can be used to improve the parameter estimation. The input data is free of noise, because it is controlled by the user. However, if one would only filter the output data, one would not only identify the physical system, but also the filter. This is why both input \textbf{and} output data are filtered. 
\\\\
First, a low-pass Butterworth filter is examined. The order of the filter is chosen higher than the system in order to have more flexibility and to have a strong enough attenuation of high frequencies. On the other hand, the order may not be too high, otherwise both input and output data have a big delay. In this manner, a $6^{\text{th}}$ order filter is used. 
\\\\
In addition, the cut-off frequency must be smaller than half the sample rate. Normally, the cut-off is determined as the frequency where the magnitude of the \textbf{exact} model is equal to 3 dB. Though, the exact model of the system is not known, so one has to rely on trial and error. For now, the cut-off is approximated by the bandwidth of the unfiltered identified model, which is given in Table \ref{tab:overview}. In Subsection X, this cut-off is further optimised in order to minimize the error between the identified model and the empirical values.


\begin{table}[htp]
	\centering
	\caption{Overview of the complex and simple models for each motor, after applying a Butterworth filter.}
	\label{tab:overview_BW}
	\bgroup
	\def\arraystretch{1.8}
	\begin{tabular}{|c||cc||cc|}
		\hline & \multicolumn{2}{c||}{\textbf{Complex}} & \multicolumn{2}{c|}{\textbf{Simple}} 
		\\ \hline \hline
		& \multicolumn{1}{c|}{Motor A} & Motor B & \multicolumn{1}{c|}{Motor A} & Motor B
		\\ \hline
		Transfer function & \multicolumn{1}{c|}{\scalebox{1.15}{$\frac{0.6952\text{ }z + 0.7978}{z^3 - 0.04632\text{ }z^2 - 0.242\text{ }z}$}} & \scalebox{1.15}{$\frac{0.6901\text{ }z + 0.6834}{z^3 - 0.2128\text{ }z^2 - 0.1303\text{ }z}$} & \multicolumn{1}{c|}{\scalebox{1.15}{$\frac{ 0.8842}{z^2 - 0.5787\text{ }z}$}} & \scalebox{1.15}{$\frac{0.8832}{z^2 - 0.5778\text{ }z}$} 
		\\ \hline
		Poles [rad/s] & \multicolumn{1}{c|}{66.2; 323; NaN} & 72.8; 340; NaN & \multicolumn{1}{c|}{54.7; NaN} & 54.9; NaN
		\\ \hline
		Zeros [rad/s] & \multicolumn{1}{c|}{314} & 314 & \multicolumn{1}{c|}{/} & /
		\\ \hline
	\end{tabular}
	\egroup
\end{table}




% ---------------------------------------------------------------------------

\subsection{Experimental Model Validation}

% ---------------------------------------------------------------------------
% ---------------------------------------------------------------------------

\section{Identification of the Cart on the Ground}

% ---------------------------------------------------------------------------

\subsection{Model Validation}

% ---------------------------------------------------------------------------

\subsection{Re-identification}












\section*{Conclusion}
Yeet
\end{document}